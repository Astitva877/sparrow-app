import { type KeyValueChecked } from "@sparrow/common/types/workspace";
import { TabTypeEnum, type Path } from "@sparrow/common/types/workspace/tab";
import {
  SocketDataTypeEnum,
  SocketSectionEnum,
  WebSocketDefault,
  type State,
  type WebSocketTab,
} from "@sparrow/common/types/workspace/web-socket";
import { v4 as uuidv4 } from "uuid";
import { SocketIoDefault } from "../types/workspace/socket-io-request-tab";

class InitSocketIoTab {
  private generateWebSocketKey() {
    const array = new Uint8Array(16);
    window.crypto.getRandomValues(array);
    return btoa(String.fromCharCode.apply(null, array as unknown as number[]));
  }
  private _tab: WebSocketTab;
  /**
   *
   * @param _id - Request mongo id
   * @param _workspaceId - Workspace Id to which Request belongs to
   */
  constructor(_id: string, _workspaceId: string) {
    this._tab = {
      id: _id,
      tabId: uuidv4(),
      name: SocketIoDefault.NAME,
      type: TabTypeEnum.SOCKET_IO,
      description: "",
      source: "USER",
      isDeleted: false,
      activeSync: false,
      property: {
        websocket: {
          url: "",
          headers: [
            {
              key: "",
              value: "",
              checked: false,
            },
          ],
          queryParams: [
            {
              key: "",
              value: "",
              checked: false,
            },
          ],
          autoGeneratedHeaders: [
            {
              key: "Sec-WebSocket-Version",
              value: "13",
              checked: true,
            },
            {
              key: "Sec-WebSocket-Key",
              value: this.generateWebSocketKey(),
              checked: true,
            },
          ],
          message: "",
          state: {
            socketNavigation: SocketSectionEnum.MESSAGE,
            socketMessageLanguage: SocketDataTypeEnum.TEXT,
            socketLeftSplitterWidthPercentage: 50,
            socketRightSplitterWidthPercentage: 50,
            isSaveSocketInProgress: false,
            isParameterBulkEditActive: false,
            isHeaderBulkEditActive: false,
          },
        },
      },
      path: {
        workspaceId: _workspaceId,
        collectionId: "",
        folderId: "",
      },
      isSaved: true,
      index: 0,
      isActive: true,
      timestamp: new Date().toString(),
    };
    if (!_id || !_workspaceId) {
      console.error("invalid id or workspace id on create new tab web socket!");
    }
  }
  public getValue(): WebSocketTab {
    return this._tab;
  }
  public updateId(_id: string) {
    this._tab.id = _id;
    return this;
  }
  public updateName(_name: string) {
    this._tab.name = _name;
    return this;
  }
  public updateDescription(_description: string) {
    this._tab.description = _description;
    return this;
  }
  public updatePath(_path: Path) {
    this._tab.path = _path;
    return this;
  }
  public updateUrl(_url: string) {
    if (_url) {
      this._tab.property.websocket.url = _url;
    }
    return this;
  }
  public updateQueryParams(_queryParams: KeyValueChecked[]) {
    if (_queryParams) {
      this._tab.property.websocket.queryParams = _queryParams;
    }
    return this;
  }
  public updateHeaders(_headers: KeyValueChecked[]) {
    if (_headers) {
      this._tab.property.websocket.headers = _headers;
    }
    return this;
  }
  public updateMessage(_message: string) {
    this._tab.property.websocket.message = _message;
    return this;
  }
  public updateAutoGeneratedHeaders(_autoGeneratedHeaders: KeyValueChecked[]) {
    this._tab.property.websocket.autoGeneratedHeaders = _autoGeneratedHeaders;
    return this;
  }
  public updateIsSave(_isSave: boolean) {
    this._tab.isSaved = _isSave;
    return this;
  }
  public updateState(_state: Partial<State>) {
    this._tab.property.websocket.state = {
      ...this._tab.property.websocket.state,
      ..._state,
    };
    return this;
  }
}

export { InitSocketIoTab };
