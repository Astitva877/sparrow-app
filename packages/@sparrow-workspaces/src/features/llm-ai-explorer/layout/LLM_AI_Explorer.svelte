<script lang="ts">
  // ---- Assets
  import { floppyDiskIcon as floppyDisk } from "@sparrow/library/assets";

  // ---- Components
  import {
    HttpUrlSection,
    RequestHeaders,
    RequestNavigator,
    ResponseNavigator,
    RequestAuth,
    ResponseDefaultScreen,
    ResponseErrorScreen,
    ResponseHeaders,
    ResponseBodyNavigator,
    RequestBody,
    RequestName,
    ResponseBody,
    RestExtensionPanel,
    RequestParameters,
    ResponseStatus,
    ChatBot,
  } from "../components";
  import { Loader } from "@sparrow/library/ui";
  import { notifications } from "@sparrow/library/ui";
  import { Splitpanes, Pane } from "svelte-splitpanes";
  import { Button } from "@sparrow/library/ui";

  import MixpanelEvent from "@app/utils/mixpanel/MixpanelEvent";
  import type { CollectionDocument } from "@app/database/database";
  import {
    Events,
    RequestDataset,
    RequestDataType,
  } from "@sparrow/common/enums";
  import type { Observable } from "rxjs";
  import { SaveAsCollectionItem } from "@sparrow/workspaces/features";
  import type {
    ClearResponseType,
    CreateCollectionType,
    CreateFolderType,
    ReadCollectionType,
    ReadRequestOrFolderInCollectionType,
    ReadWorkspaceType,
    SaveAsRequestType,
    SaveRequestType,
    SendRequestType,
    UpdateAutoGeneratedHeadersType,
    UpdateHeadersType,
    UpdateParamsType,
    UpdateRequestAuthType,
    UpdateRequestBodyType,
    UpdateRequestDescriptionType,
    UpdateRequestMethodType,
    UpdateRequestNameType,
    UpdateRequestStateType,
    UpdateRequestUrlType,
  } from "@sparrow/workspaces/type";
  import {
    RequestDatasetEnum,
    RequestDataTypeEnum,
    RequestSectionEnum,
    ResponseSectionEnum,
    type KeyValue,
  } from "@sparrow/common/types/workspace";
  import {
    tabsSplitterDirection,
    isChatbotOpenInCurrTab,
  } from "../../../stores";
  import { Popover } from "@sparrow/library/ui";
  import { onDestroy, onMount } from "svelte";
  import { Carousel, Modal } from "@sparrow/library/ui";
  import RequestDoc from "../components/request-doc/RequestDoc.svelte";
  import {
    AdvanceAPI,
    CreateCollection,
    SendingApiRequest,
  } from "@sparrow/workspaces/constants";
  import { ResponseStatusCode } from "@sparrow/common/enums";

  import type { CancelRequestType } from "@workspaces/common/type/actions";
  import type { restExplorerData } from "../store/llm-ai-explorer";
  import type { Tab } from "@sparrow/common/types/workspace/tab";
  import {
    CheckmarkCircleFilled,
    ErrorCircleFilled,
    CaretDownFilled,
  } from "@sparrow/library/icons";

  import { SparrowSecondaryIcon, SparkleFilled } from "@sparrow/common/icons";
  import { loadingState } from "../../../../../@sparrow-common/src/store";
  import { writable } from "svelte/store";

  import type { KeyValuePair } from "@sparrow/common/interfaces/request.interface";
  import { LLM_AI_RequestSectionEnum } from "@sparrow/common/types/workspace/llm-ai-request-tab";

  export let tab: Observable<Tab>;
  export let collections: Observable<CollectionDocument[]>;
  export let requestAuthHeader: Observable<KeyValue>;
  export let requestAuthParameter: Observable<KeyValue>;
  export let onUpdateRequestUrl: UpdateRequestUrlType;
  export let onSendRequest: SendRequestType;
  export let onCancelRequest: CancelRequestType;
  export let onUpdateRequestMethod: UpdateRequestMethodType;
  export let onUpdateRequestParams: UpdateParamsType;
  export let onUpdateRequestName: UpdateRequestNameType;
  export let onUpdateRequestBody: UpdateRequestBodyType;
  export let onUpdateRequestAuth: UpdateRequestAuthType;
  export let onUpdateHeaders: UpdateHeadersType;
  export let onUpdateAutoGeneratedHeaders: UpdateAutoGeneratedHeadersType;
  export let onUpdateRequestState: UpdateRequestStateType;
  export let onUpdateResponseState;
  export let onClearResponse: ClearResponseType;
  export let onSaveRequest: SaveRequestType;
  export let onUpdateAiSystemPrompt: UpdateRequestDescriptionType;
  export let readRequestOrFolderInCollection: ReadRequestOrFolderInCollectionType;
  export let readCollection: ReadCollectionType;
  export let readWorkspace: ReadWorkspaceType;
  export let onSaveAsRequest: SaveAsRequestType;
  export let onCreateFolder: CreateFolderType;
  export let onCreateCollection: CreateCollectionType;
  export let onUpdateEnvironment;
  export let environmentVariables;
  export let isGuestUser = false;
  export let onOpenCollection;

  export let onGenerateAiResponse;
  export let onToggleLike;

  // export let isLoginBannerActive = false;
  export let isPopoverContainer = true;
  export let onFetchCollectionGuide: (query) => void;
  export let onUpdateCollectionGuide: (query, isActive) => void;
  export let onUpdateAiPrompt;
  export let onUpdateAiConversation;
  export let onGenerateDocumentation;
  export let onStopGeneratingAIResponse;

  /**
   * Role of user in active workspace
   */
  export let userRole;
  export let storeData: restExplorerData | undefined;
  export let isTourGuideOpen = false;
  export let isWebApp = false;
  export let azureBlobCDN;
  export let onSaveResponse;
  export let collectionAuth;
  export let collection;
  const loading = writable<boolean>(false);

  // Props for showing merge/diff view in RequestBody, Headers and Params
  let isAIDebugBtnEnable = false;
  let isMergeViewEnableForRequestBody = false;
  let isMergeViewEnableForParams = false;
  let isMergeViewEnableForHeaders = false;
  let isMergeViewLoading = false;
  let newModifiedContent: string | KeyValuePair[];
  let mergeViewRequestDatasetType: RequestDatasetEnum;

  // Reference to the splitpane container element
  let splitpaneContainer;
  let splitpaneContainerWidth = 0;

  // Chatbot pane size constraints in pixels (based on Figma design)
  const minPx = 343;
  const maxPx = 525;
  const defaultPx = 452;

  // Chatbot pane size constraints in percentage (calculated at runtime)
  let minSizePct = 0;
  let maxSizePct = 0;
  let defaultSizePct = 0;

  /**
   * Converts the pixel-based min, max, and default sizes
   * of the chatbot pane into percentages relative to the
   * current width of the splitpane container.
   *
   * Required because `svelte-splitpane` accepts sizes in percentages.
   */
  function updateSplitpaneContSizes() {
    if (!splitpaneContainer) return;

    splitpaneContainerWidth = splitpaneContainer.clientWidth;

    minSizePct = (minPx / splitpaneContainerWidth) * 100;
    maxSizePct = (maxPx / splitpaneContainerWidth) * 100;
    defaultSizePct = (defaultPx / splitpaneContainerWidth) * 100;
  }

  const closeCollectionHelpText = () => {
    onUpdateCollectionGuide({ id: "collection-guide" }, false);
    isPopoverContainer = !isPopoverContainer;
  };

  onMount(async () => {
    const event = await onFetchCollectionGuide({
      id: "collection-guide",
    });
    event?.$.subscribe((e) => {
      if (e.isActive === false) {
        isPopoverContainer = false;
      } else {
        isPopoverContainer = true;
      }
    });

    // Delay to ensure DOM is ready before measuring container width
    setTimeout(() => {
      updateSplitpaneContSizes();
      // Watch for container size changes and update pane size percentages
      const resizeObserver = new ResizeObserver(() => {
        updateSplitpaneContSizes();
      });
      resizeObserver.observe(splitpaneContainer);
      return () => resizeObserver.disconnect(); // Cleanup on component unmount
    }, 0);
  });

  export let onRenameCollection;
  export let onRenameFolder;

  let isExposeSaveAsRequest = false;
  let isLoading = true;
  let isErrorMsgOpen = false;

  $: {
    if ($tab?.property?.request?.url?.length > 0) {
      isLoading = false;
    }
  }
  $: {
    if (isTourGuideOpen) {
      isGuidePopup = true;
    }
  }
  const toggleSaveRequest = (flag: boolean): void => {
    isExposeSaveAsRequest = flag;
  };

  $: {
    loadingState.subscribe((tab) => {
      loading.set(tab.get($tab.tabId));
    });
  }
  let isGuidePopup = false;

  onDestroy(() => {
    // isChatbotOpenInCurrTab.set(false);
  });

  setTimeout(() => {
    console.log("tab data :>> ", $tab);
  }, 3000);

  console.log("isChatBot active ;>> ", $tab?.property?.llm_ai_request?.state);
</script>

{#if $tab.tabId}
  <div class="d-flex rest-explorer-layout h-100">
    <div class="w-100 d-flex flex-column h-100 p-3">
      <div class="d-flex justify-content-between w-100 p-3 d-none">
        <RequestName name={$tab.name} {onUpdateRequestName} />

        <div class="d-flex justify-content-between"></div>
      </div>

      <!-- HTTP URL Section -->
      <HttpUrlSection
        class=""
        isSaveLoad={$loading}
        isSave={$tab.isSaved}
        bind:userRole
        requestUrl={` ${$tab.property.llm_ai_request?.AI_Model_Provider} | ${$tab.property.llm_ai_request?.AI_Model_Variant}`}
        httpMethod={$tab.property.llm_ai_request?.ai}
        isSendRequestInProgress={storeData?.isSendRequestInProgress}
        {onUpdateEnvironment}
        {environmentVariables}
        {onUpdateRequestUrl}
        {onUpdateRequestMethod}
        {toggleSaveRequest}
        {onSaveRequest}
        {isGuestUser}
      />

      <div
        bind:this={splitpaneContainer}
        style="flex:1; overflow:auto; margin-top: 12px;"
      >
        <Splitpanes class="explorer-chatbot-splitter">
          <Pane class="position-relative bg-transparent">
            <div style="flex:1; overflow:auto; margin-top: 12px;">
              <!-- Request Pane -->
              <div class="h-100 d-flex flex-column position-relative">
                <RequestNavigator
                  requestStateSection={$tab.property.llm_ai_request?.state
                    ?.LLM_AI_Navigation}
                  {onUpdateRequestState}
                  authParameterLength={1}
                  authHeaderLength={1}
                />
                <div style="flex:1; overflow:auto;" class="p-0">
                  {#if $tab.property.llm_ai_request?.state?.LLM_AI_Navigation === LLM_AI_RequestSectionEnum.SYSTEM_PROMPT}
                    <RequestDoc
                      {onUpdateAiSystemPrompt}
                      requestDoc={$tab.property.llm_ai_request.SystemPrompt}
                    />
                  {:else if $tab.property.llm_ai_request?.state?.LLM_AI_Navigation === LLM_AI_RequestSectionEnum.AUTHORIZATION}
                    <RequestAuth
                      requestStateAuth={$tab.property.llm_ai_request.state
                        .LLM_AI_AuthNavigation}
                      auth={$tab.property.llm_ai_request.auth}
                      collectionAuth={$collectionAuth}
                      {onUpdateRequestState}
                      {onUpdateRequestAuth}
                      {onUpdateEnvironment}
                      {environmentVariables}
                      {collection}
                      {onOpenCollection}
                    />
                  {:else if $tab.property.llm_ai_request?.state?.LLM_AI_Navigation === LLM_AI_RequestSectionEnum.AI_MODAL_CONFIGURATIONS}
                    <div
                      class="w-100 h-100 d-flex align-items-center justify-content-center opacity-50"
                    >
                      <h4>Coming soon ...</h4>
                    </div>
                  {/if}
                </div>
              </div>
            </div>
          </Pane>

          <Pane
            class="position-relative bg-transparent"
            minSize={minSizePct}
            size={defaultSizePct}
            maxSize={maxSizePct}
          >
            <ChatBot
              {tab}
              {onUpdateAiPrompt}
              {onUpdateAiConversation}
              {onUpdateRequestState}
              {onGenerateAiResponse}
              {onStopGeneratingAIResponse}
              {onToggleLike}
              handleApplyChangeOnAISuggestion={() => {}}
            />
          </Pane>
        </Splitpanes>
      </div>
    </div>
    <!--
      --
       -- Rest extension panel is set to display none 
      --
    -->
    <!-- <div class="d-none">
      <RestExtensionPanel
        state={$tab.property.request?.state}
        requestMethod={$tab.property.request?.method}
        requestUrl={$tab.property.request?.url}
        requestName={$tab.name}
        requestDescription={$tab.description}
        requestPath={$tab.path}
        collections={$collections}
        {onSaveRequest}
        {readCollection}
        {readWorkspace}
        {onSaveAsRequest}
        {onCreateFolder}
        {onCreateCollection}
        {onUpdateRequestState}
        {onUpdateRequestDescription}
        {readRequestOrFolderInCollection}
      />
    </div> -->
  </div>
  <!-- <Modal
    title={"Save Request"}
    type={"dark"}
    width={"55%"}
    zIndex={10000}
    isOpen={isExposeSaveAsRequest}
    handleModalState={(flag = false) => {
      isExposeSaveAsRequest = flag;
    }}
  >
    <SaveAsCollectionItem
      onClick={(flag = false) => {
        isExposeSaveAsRequest = flag;
      }}
      requestMethod={$tab.property.request?.method}
      requestUrl={$tab.property.request?.url}
      requestName={$tab.name}
      requestDescription={$tab.description}
      requestPath={$tab.path}
      collections={$collections}
      {readWorkspace}
      onSave={onSaveAsRequest}
      {onCreateFolder}
      {onCreateCollection}
      {onRenameCollection}
      {onRenameFolder}
    />
  </Modal> -->
{/if}

<!-- ChatBot Toggler -->
<!-- {#if !isGuestUser}
  <div
    style="position: fixed;
        bottom: 28px;
        right:30px;
        z-index: 200;"
  >
    <div
      class="sparrow-ai-icon"
      role="button"
      on:click={() => {
        if ($tabsSplitterDirection != "horizontal") {
          tabsSplitterDirection.set("horizontal");
          isChatbotOpenInCurrTab.set(true);
        }
        onUpdateRequestState({
          isChatbotActive: !$tab?.property?.request?.state?.isChatbotActive,
        });

        MixpanelEvent(Events.AI_Chat_Initiation);
      }}
    >
      <div
        class="chatten-box"
        tabindex="0"
        style="display: {!$tab?.property?.request?.state?.isChatbotActive
          ? 'flex'
          : 'none'}"
      >
        <SparrowSecondaryIcon />
      </div>
    </div>
  </div>
{/if} -->

<style>
  .chatten-box {
    background-color: var(--bg-ds-primary-400);
    height: 40px;
    width: 40px;
    border-radius: 6px;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  .chatten-box:hover {
    background-color: var(--bg-ds-primary-500);
  }
  .chatten-box:focus-visible {
    height: 40px;
    width: 40px;
    border-radius: 10px;
    border: 2px solid var(--border-ds-primary-300);
    outline: none;
  }

  .rest-explorer-layout {
    background-color: var(--bg-ds-surface-900);
  }

  :global(.rest-splitter.splitpanes--vertical > .splitpanes__splitter) {
    width: 11px !important;
    height: 100% !important;
    background-color: var(--bg-secondary-500) !important;
    border-left: 5px solid var(--border-ds-surface-900) !important;
    border-right: 5px solid var(--border-ds-surface-900) !important;
    border-top: 0 !important;
    border-bottom: 0 !important;
  }
  :global(.rest-splitter.splitpanes--horizontal > .splitpanes__splitter) {
    height: 11px !important;
    width: 100% !important;
    background-color: var(--bg-ds-surface-100) !important;
    border-top: 5px solid var(--border-ds-surface-900) !important;
    border-bottom: 5px solid var(--border-ds-surface-900) !important;
    border-left: 0 !important;
    border-right: 0 !important;
  }
  :global(
    .rest-splitter > .splitpanes__splitter:active,
    .rest-splitter > .splitpanes__splitter:hover
  ) {
    background-color: var(--bg-ds-primary-400) !important;
  }

  /* Disabling the splitter for explorer and chatbot interface - only split dragger is allowed on hover */
  :global(
    .explorer-chatbot-splitter.splitpanes--vertical > .splitpanes__splitter
  ) {
    width: 8px !important;
    border: none !important;
    background: transparent !important;
  }

  :global(
    .explorer-chatbot-splitter.splitpanes--vertical
      > .splitpanes__splitter:hover,
    .explorer-chatbot-splitter.splitpanes--vertical
      > .splitpanes__splitter:active
  ) {
    border: none !important;
    border-right: 2px solid var(--border-ds-primary-300) !important;
    background: transparent !important;
  }

  .link {
    color: var(--text-primary-300);
    text-decoration: underline;
    cursor: pointer;
  }
</style>
