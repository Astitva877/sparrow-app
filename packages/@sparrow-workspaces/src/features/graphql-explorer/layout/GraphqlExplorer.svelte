<script lang="ts">
  // ---- Assets
  import { floppyDiskIcon as floppyDisk } from "@sparrow/library/assets";

  // ---- Components
  import {
    HttpUrlSection,
    RequestHeaders,
    RequestNavigator,
    ResponseNavigator,
    RequestAuth,
    ResponseDefaultScreen,
    ResponseErrorScreen,
    ResponseHeaders,
    ResponseBodyNavigator,
    RequestName,
    ResponseStatus,
    ResponseBody,
  } from "../components";
  import { Loader } from "@sparrow/library/ui";
  import { notifications } from "@sparrow/library/ui";
  import { Splitpanes, Pane } from "svelte-splitpanes";
  import { Button } from "@sparrow/library/ui";

  import type { CollectionDocument } from "@app/database/database";
  import type { Observable } from "rxjs";
  import { SaveAsCollectionItem } from "@sparrow/workspaces/features";
  import type {
    ClearResponseType,
    CreateCollectionType,
    CreateFolderType,
    ReadCollectionType,
    ReadRequestOrFolderInCollectionType,
    ReadWorkspaceType,
    SaveAsRequestType,
    SaveRequestType,
    SendRequestType,
    UpdateAutoGeneratedHeadersType,
    UpdateHeadersType,
    UpdateParamsType,
    UpdateRequestAuthType,
    UpdateRequestBodyType,
    UpdateRequestDescriptionType,
    UpdateRequestMethodType,
    UpdateRequestNameType,
    UpdateRequestStateType,
    UpdateRequestUrlType,
  } from "@sparrow/workspaces/type";
  import {
    RequestSectionEnum,
    ResponseSectionEnum,
    type KeyValue,
  } from "@sparrow/common/types/workspace";
  import { requestSplitterDirection, type graphqlExplorerData } from "../store";

  import { Modal } from "@sparrow/library/ui";
  import { ResponseStatusCode } from "@sparrow/common/enums";

  import type { CancelRequestType } from "@workspaces/common/type/actions";
  import { GraphqlRequestSectionTabEnum } from "@sparrow/common/types/workspace/graphql-request-tab";

  export let tab: Observable<any>;
  export let collections: Observable<CollectionDocument[]>;
  export let requestAuthHeader: Observable<KeyValue>;
  export let onUpdateRequestUrl: UpdateRequestUrlType;
  export let onSendRequest: SendRequestType;
  export let onCancelRequest: CancelRequestType;
  export let onUpdateRequestMethod: UpdateRequestMethodType;
  export let onUpdateRequestName: UpdateRequestNameType;
  export let onUpdateRequestAuth: UpdateRequestAuthType;
  export let onUpdateHeaders: UpdateHeadersType;
  export let onUpdateAutoGeneratedHeaders: UpdateAutoGeneratedHeadersType;
  export let onUpdateRequestState: UpdateRequestStateType;
  export let onUpdateResponseState;
  export let onClearResponse: ClearResponseType;
  export let onSaveRequest: SaveRequestType;
  export let readWorkspace: ReadWorkspaceType;
  export let onSaveAsRequest: SaveAsRequestType;
  export let onCreateFolder: CreateFolderType;
  export let onCreateCollection: CreateCollectionType;
  export let onUpdateEnvironment;
  export let environmentVariables;
  export let isGuestUser = false;

  /**
   * Role of user in active workspace
   */
  export let userRole;
  export let storeData: graphqlExplorerData | undefined;
  export let isTourGuideOpen = false;
  export let onRenameCollection;
  export let onRenameFolder;

  let isExposeSaveAsRequest = false;
  let isLoading = true;
  $: {
    if ($tab?.property?.graphql?.url?.length > 0) {
      isLoading = false;
    }
  }
  $: {
    if (isTourGuideOpen) {
      isGuidePopup = true;
    }
  }
  const toggleSaveRequest = (flag: boolean): void => {
    isExposeSaveAsRequest = flag;
  };
  let isGuidePopup = false;
</script>

{#if $tab.tabId}
  <div class="d-flex rest-explorer-layout h-100">
    <div class="w-100 d-flex flex-column h-100 px-3 pt-3 pb-2">
      <!-- Request Name Header -->
      <!-- 
        --
        -- Rest name header is set to display none 
        --
      -->
      <div class="d-flex justify-content-between w-100 p-3 d-none">
        <RequestName name={$tab.name} {onUpdateRequestName} />

        <div class="d-flex justify-content-between">
          <Button
            title="Save Request"
            type="dark"
            loader={false}
            buttonClassProp="ms-2"
            buttonStartIcon={floppyDisk}
            onClick={async () => {
              const x = await onSaveRequest();
              if (
                x.status === "error" &&
                x.message ===
                  "request is not a part of any workspace or collection"
              ) {
                isExposeSaveAsRequest = true;
              } else if (x.status === "success") {
                notifications.success("API request saved successfully.");
              }
            }}
          />

          <span class="position-relative" style="width:35px;"> </span>
          <Button
            title="Share"
            type="dark"
            buttonClassProp="ms-2"
            onClick={() => {}}
          />
        </div>
      </div>

      <!-- HTTP URL Section -->
      <HttpUrlSection
        class=""
        isSave={$tab.isSaved}
        bind:userRole
        requestUrl={$tab.property.graphql.url}
        isSendRequestInProgress={storeData?.isSendRequestInProgress}
        onSendButtonClicked={onSendRequest}
        onCancelButtonClicked={onCancelRequest}
        {onUpdateEnvironment}
        {environmentVariables}
        {onUpdateRequestUrl}
        {onUpdateRequestMethod}
        {toggleSaveRequest}
        {onSaveRequest}
        {isGuestUser}
      />
      <!--Disabling the Quick Help feature, will be taken up in next release-->
      <div class="" style="margin-top: 10px;"></div>
      <div class="pt-2"></div>
      <div style="flex:1; overflow:auto;">
        {#if !isLoading}
          <Splitpanes
            class="rest-splitter w-100 h-100"
            id={"rest-splitter"}
            horizontal={$requestSplitterDirection === "horizontal"
              ? true
              : false}
            dblClickSplitter={false}
            on:resize={(e) => {
              onUpdateRequestState({
                requestLeftSplitterWidthPercentage: e.detail[0].size,
              });
              onUpdateRequestState({
                requestRightSplitterWidthPercentage: e.detail[1].size,
              });
            }}
          >
            <Pane
              minSize={30}
              size={$tab.property.graphql?.state
                ?.requestLeftSplitterWidthPercentage}
              class="position-relative bg-secondary-850-important"
            >
              <!-- Request Pane -->
              <div
                class="h-100 d-flex flex-column position-relative {$requestSplitterDirection ===
                'horizontal'
                  ? 'pb-1'
                  : 'pe-2'}"
              >
                <RequestNavigator
                  requestStateSection={$tab.property.graphql?.state
                    ?.requestNavigation}
                  {onUpdateRequestState}
                  authHeaderLength={$requestAuthHeader.value ? 1 : 0}
                  headersLength={$tab.property?.graphql?.headers?.length || 0}
                  autoGeneratedHeadersLength={$tab.property?.graphql
                    ?.autoGeneratedHeaders?.length || 0}
                />
                <div style="flex:1; overflow:auto;" class="p-0">
                  {#if $tab.property.graphql?.state?.requestNavigation === GraphqlRequestSectionTabEnum.QUERY}
                    QUERY
                  {:else if $tab.property.graphql?.state?.requestNavigation === GraphqlRequestSectionTabEnum.Schema}
                    SCHEMA
                  {:else if $tab.property.graphql?.state?.requestNavigation === RequestSectionEnum.HEADERS}
                    <RequestHeaders
                      isBulkEditActive={$tab?.property?.graphql.state
                        ?.isHeaderBulkEditActive}
                      {onUpdateRequestState}
                      {environmentVariables}
                      {onUpdateEnvironment}
                      headers={$tab.property.graphql.headers}
                      autoGeneratedHeaders={$tab.property.graphql
                        .autoGeneratedHeaders}
                      authHeader={$requestAuthHeader}
                      onHeadersChange={onUpdateHeaders}
                      onAutoGeneratedHeadersChange={onUpdateAutoGeneratedHeaders}
                    />
                  {:else if $tab.property.graphql?.state?.requestNavigation === RequestSectionEnum.AUTHORIZATION}
                    <RequestAuth
                      requestStateAuth={$tab.property.graphql.state
                        .requestAuthNavigation}
                      {onUpdateRequestState}
                      auth={$tab.property.graphql.auth}
                      {onUpdateRequestAuth}
                      {onUpdateEnvironment}
                      {environmentVariables}
                    />
                  {/if}
                </div>
              </div>
            </Pane>
            <Pane
              minSize={30}
              size={$tab.property.graphql?.state
                ?.requestRightSplitterWidthPercentage}
              class="bg-secondary-850-important position-relative"
            >
              <!-- Response Pane -->
              <div
                class="d-flex flex-column h-100 {$requestSplitterDirection ===
                'horizontal'
                  ? 'pt-1'
                  : 'ps-2'}"
                style="overflow:auto;"
              >
                <div class="h-100 d-flex flex-column">
                  <div style="flex:1; overflow:auto;">
                    {#if storeData?.isSendRequestInProgress}
                      <ResponseDefaultScreen />
                      <div
                        style="top: 0px; left: 0; right: 0; bottom: 0; z-index:3; position:absolute;"
                      >
                        <Loader loaderSize={"20px"} />
                      </div>
                    {:else if !storeData?.response.status}
                      <ResponseDefaultScreen />
                    {:else if storeData?.response.status === ResponseStatusCode.ERROR}
                      <ResponseErrorScreen />
                    {:else if storeData?.response.status}
                      <div class="h-100 d-flex flex-column">
                        <ResponseStatus response={storeData.response} />
                        <ResponseNavigator
                          requestStateSection={storeData?.response.navigation}
                          {onUpdateResponseState}
                          responseHeadersLength={storeData?.response.headers
                            ?.length || 0}
                        />
                        {#if storeData?.response.navigation === ResponseSectionEnum.RESPONSE}
                          {#if storeData?.response.bodyLanguage !== "Image"}
                            <ResponseBodyNavigator
                              response={storeData?.response}
                              apiState={storeData?.response}
                              {onUpdateResponseState}
                              {onClearResponse}
                            />
                          {/if}
                          <div style="flex:1; overflow:auto;">
                            <ResponseBody
                              response={storeData?.response}
                              apiState={storeData?.response}
                            />
                          </div>
                        {:else if storeData?.response.navigation === ResponseSectionEnum.HEADERS}
                          <div style="flex:1; overflow:auto;">
                            <ResponseHeaders
                              responseHeader={storeData.response?.headers}
                            />
                          </div>
                        {/if}
                      </div>
                    {/if}
                  </div>
                </div>
              </div></Pane
            >
          </Splitpanes>
        {:else}
          <!-- loading state -->
          <ResponseDefaultScreen isMainScreen={true} />
        {/if}
      </div>
    </div>
  </div>
  <Modal
    title={"Save Request"}
    type={"dark"}
    width={"55%"}
    zIndex={10000}
    isOpen={isExposeSaveAsRequest}
    handleModalState={(flag = false) => {
      isExposeSaveAsRequest = flag;
    }}
  >
    <SaveAsCollectionItem
      onClick={(flag = false) => {
        isExposeSaveAsRequest = flag;
      }}
      requestMethod={$tab.property.graphql?.method}
      requestUrl={$tab.property.graphql?.url}
      requestName={$tab.name}
      requestDescription={$tab.description}
      requestPath={$tab.path}
      collections={$collections}
      {readWorkspace}
      onSave={onSaveAsRequest}
      {onCreateFolder}
      {onCreateCollection}
      {onRenameCollection}
      {onRenameFolder}
    />
  </Modal>
{/if}

<style>
  .rest-explorer-layout {
    background-color: var(--bg-secondary-850);
  }

  :global(.rest-splitter.splitpanes--vertical .splitpanes__splitter) {
    width: 10.5px !important;
    height: 100% !important;
    background-color: var(--bg-secondary-500) !important;
    border-left: 5px solid var(--border-secondary-800) !important;
    border-right: 5px solid var(--border-secondary-800) !important;
    border-top: 0 !important;
    border-bottom: 0 !important;
  }
  :global(.rest-splitter.splitpanes--horizontal .splitpanes__splitter) {
    height: 10.5px !important;
    width: 100% !important;
    background-color: var(--bg-secondary-500) !important;
    border-top: 5px solid var(--border-secondary-800) !important;
    border-bottom: 5px solid var(--border-secondary-800) !important;
    border-left: 0 !important;
    border-right: 0 !important;
  }
  :global(
      .rest-splitter .splitpanes__splitter:active,
      .rest-splitter .splitpanes__splitter:hover
    ) {
    background-color: var(--bg-primary-200) !important;
  }
  .link {
    color: var(--bg-primary-300);
    text-decoration: underline;
  }
</style>
